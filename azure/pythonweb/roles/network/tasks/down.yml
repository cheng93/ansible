---
  - name: Getting {{resource_group_name}} resource group facts
    azure_rm_resourcegroup_facts:
      client_id: "{{azure_client_id}}"
      secret: "{{azure_secret}}"
      tenant: "{{azure_tenant}}"
      subscription_id: "{{azure_subscription}}"
      name: "{{resource_group_name}}"
    register: resource_group

  - block:
    - name: Getting {{virtual_network_name}} facts
      azure_rm_virtualnetwork_facts:
        client_id: "{{azure_client_id}}"
        secret: "{{azure_secret}}"
        tenant: "{{azure_tenant}}"
        subscription_id: "{{azure_subscription}}"
        resource_group: "{{resource_group_name}}"
        name: "{{virtual_network_name}}"
      register: virtual_network

    - block:
      - name: Destroy {{subnet_private_name}} subnet
        azure_rm_subnet:
          client_id: "{{azure_client_id}}"
          secret: "{{azure_secret}}"
          tenant: "{{azure_tenant}}"
          subscription_id: "{{azure_subscription}}"
          resource_group: "{{resource_group_name}}"
          virtual_network_name: "{{virtual_network_name}}"
          name: "{{subnet_private_name}}"
          state: absent

      - name: Destroy {{subnet_public_name}} subnet
        azure_rm_subnet:
          client_id: "{{azure_client_id}}"
          secret: "{{azure_secret}}"
          tenant: "{{azure_tenant}}"
          subscription_id: "{{azure_subscription}}"
          resource_group: "{{resource_group_name}}"
          virtual_network_name: "{{virtual_network_name}}"
          name: "{{subnet_public_name}}"
          state: absent
      when: virtual_network.ansible_facts.azure_virtualnetworks|length > 0

    - name: Destroy {{nsg_private_name}} network server group
      azure_rm_securitygroup:
        client_id: "{{azure_client_id}}"
        secret: "{{azure_secret}}"
        tenant: "{{azure_tenant}}"
        subscription_id: "{{azure_subscription}}"
        resource_group: "{{resource_group_name}}"
        name: "{{nsg_private_name}}"
        state: absent

    - name: Destroy {{virtual_network_name}} virtual network
      azure_rm_virtualnetwork:
        client_id: "{{azure_client_id}}"
        secret: "{{azure_secret}}"
        tenant: "{{azure_tenant}}"
        subscription_id: "{{azure_subscription}}"
        resource_group: "{{resource_group_name}}"
        name: "{{virtual_network_name}}"
        state: absent
    when: resource_group.ansible_facts.azure_resourcegroups|length > 0
